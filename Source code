import os
import shutil
import zipfile
import tkinter as tk
from tkinter import filedialog
import re
INPUT_XML = "text_ui_soul.xml"
TEMP_FOLDER = "temp_mod_input"
PAK_NAME = "English_xml.pak"
def replace_names(pebble_name: str, herring_name: str, mutt_name: str) -> str:
    with open(INPUT_XML, 'r', encoding='utf-8') as f:
        content = f.read()
        content = re.sub(r'\bPebbles\b', pebble_name, content)
        content = re.sub(r'\bHerring\b', herring_name, content)
        content = re.sub(r'\bMutt\b', mutt_name, content)
    return content
def prepare_temp(xml: str):
    if os.path.isdir(TEMP_FOLDER): shutil.rmtree(TEMP_FOLDER)
    os.makedirs(TEMP_FOLDER)
    with open(os.path.join(TEMP_FOLDER, INPUT_XML), 'w', encoding='utf-8') as f:
        f.write(xml)
def pack_pak():
    zip_path = PAK_NAME + ".zip"
    with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as z:
        for root, _, files in os.walk(TEMP_FOLDER):
            for fn in files:
                ap = os.path.join(root, fn)
                rp = os.path.relpath(ap, TEMP_FOLDER)
                z.write(ap, rp)
    if os.path.exists(PAK_NAME): os.remove(PAK_NAME)
    os.rename(zip_path, PAK_NAME)
def move_pak(base: str):
    dest = os.path.join(base, "z_NameThyCompanions", "Localization")
    os.makedirs(dest, exist_ok=True)
    target = os.path.join(dest, PAK_NAME)
    if os.path.exists(target): os.remove(target)
    shutil.move(PAK_NAME, dest)
    shutil.rmtree(TEMP_FOLDER)
def on_submit():
    pebble_name = entry_pebble.get().strip()
    herring_name = entry_herring.get().strip()
    mutt_name = entry_mutt.get().strip()
    base = entry_path.get().strip()
    
    if not pebble_name or not herring_name or not mutt_name or not base:
        status.set("Error: All fields are required.")
        return
    xml = replace_names(pebble_name, herring_name, mutt_name)
    prepare_temp(xml)
    pack_pak()
    move_pak(base)
    status.set(f"{PAK_NAME} built with replacements.")
def browse():
    d = filedialog.askdirectory()
    if d:
        entry_path.delete(0, tk.END)
        entry_path.insert(0, d)
root = tk.Tk()
root.title("Ozer's Companion Renamer")
root.geometry("300x400")
tk.Label(root, text="New Name for Pebbles:").pack(pady=2)
entry_pebble = tk.Entry(root, width=30)
entry_pebble.pack(pady=2)
tk.Label(root, text="New Name for Herring:").pack(pady=2)
entry_herring = tk.Entry(root, width=30)
entry_herring.pack(pady=2)
tk.Label(root, text="New Name for Mutt:").pack(pady=2)
entry_mutt = tk.Entry(root, width=30)
entry_mutt.pack(pady=2)
tk.Label(root, text="Select Your Mods Folder:").pack(pady=2)
entry_path = tk.Entry(root, width=30)
entry_path.pack(pady=2)
tk.Button(root, text="Browse Files", command=browse).pack(pady=2)
tk.Button(root, text="Build Mod", command=on_submit, width=20, height=2).pack(pady=50)
status = tk.StringVar()
tk.Label(root, textvariable=status).pack(pady=4)
root.mainloop()
